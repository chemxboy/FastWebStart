/*///////////////////////////////////////////////////////////////////////////////////////////////////////
///// Code mixing by Molokoloco ..... 2010 ......... [EVER IN PROGRESS (it's not done yet)]  ///////////
////  SOURCES here : https://github.com/molokoloco/FastWebStart/                            ///////////
////  My WIKI here : http://code.google.com/p/molokoloco-coding-project/wiki/WikiMenu      /////////// 
////////////////////////////////////////////////////////////////////////////////////////////////// */
var title,href,result,tips,allFields,tipsError,editedByUser=false,action="edit",edLink="",edCat="",updateTips=function(a){tipsError.text(a).addClass("ui-state-highlight");setTimeout(function(){tipsError.removeClass("ui-state-highlight",1500)},500)},checkLength=function(a,b,c,d){if(a.val().length>d||a.val().length<c){a.addClass("ui-state-error");updateTips("La longueur du "+b+" doit &ecirc;tre entre "+c+" et "+d+" charact&egrave;res.");return false}else return true},checkRegexp=function(a,b,c){if(b.test(a.val()))return true; else{a.addClass("ui-state-error");updateTips(c);return false}},initDial=function(){$("div#divEdit").show();$("div#divEdit").dialog({autoOpen:false,height:360,minHeight:360,width:420,minWidth:420,modal:true,close:function(){allFields.val("").removeClass("ui-state-error")}})},createCatEditForm=function(){$("div#divEdit").length<1?$("body").append('<div id="divEdit" title=""></div>'):$("div#divEdit").dialog("destroy");$("div#divEdit").hide();var a='<form method="post" action="#" name="formEdit" id="formEdit">'; a+="<fieldset><legend>Les champs avec <em>*</em> sont obligatoires</legend>";a+='<label for="title" title="Titre du site">Titre de la cat&eacute;gorie<em>*</em> <input type="text" name="title" id="title" value="" class="text ui-widget-content ui-corner-all" maxlength="12"/></label>';a+="</fieldset></form>";$("div#divEdit").html(a)},createLinkEditForm=function(){$("div#divEdit").length<1?$("body").append('<div id="divEdit" title=""></div>'):$("div#divEdit").dialog("destroy");$("div#divEdit").hide(); var a='<form method="post" action="#" name="formEdit" id="formEdit">';a+='<fieldset><legend id="legend">Les champs avec <em>*</em> sont obligatoires</legend>';a+='<label for="title" title="Titre du site">Titre du site<em>*</em> <input type="text" name="title" id="title" value="" class="text ui-widget-content ui-corner-all" maxlength="30"/></label>';a+='<label for="href" title="Lien http:// du site">Lien<em>*</em> <input type="text" name="href" id="href" value="" class="text ui-widget-content ui-corner-all"/></label>'; a+='<label for="result" title="Faite une recherche sur le site, regardez l\'url et remplacez votre mot-cl&eacute; par {R}">R&eacute;sultat recherche <input type="text" name="result" id="result" value="" class="text ui-widget-content ui-corner-all"/></label>';a+='<label for="tips" title="En g&eacute;n&eacute;ral, le titre de la page">Description <input type="text" name="tips" id="tips" value="" class="text ui-widget-content ui-corner-all"/></label>';a+="</fieldset></form>";$("div#divEdit").html(a)}, catEdit=function(a){a.preventDefault();edCat=$(a.currentTarget);action=edCat.hasClass("addCat")?"add":"edit";createCatEditForm();title=$("input#title");allFields=$([]).add(title);tipsError=$("legend#legend");if(action=="add"){$("div#divEdit").attr({title:"Ajouter une cat&eacute;gorie"});title.val("")}else{$("div#divEdit").attr({title:"Edition d'une cat&eacute;gorie"});title.val(edCat.text())}a={};$.extend(a,{Annuler:function(){$(this).dialog("close")}});$.extend(a,{Valider:function(){var b=true;allFields.removeClass("ui-state-error"); if(b=(b=b&&checkLength(title,"Titre",2,25))&&checkRegexp(title,/^([A-Za-z0-9_\- \u00e9\u00e8\u00eb\u00ea\u00e0\u00f9\u00e7\u00ee\u00f4\u00f6])+$/i,"Categorie name may consist of letters and numbers, underscores or dash")){action!="add"&&edCat.html(title.val());$(this).dialog("close");initLinkEvent();isEditedByUser()}}});initDial();$("div#divEdit").dialog("option","buttons",a);$("div#divEdit").dialog("option","height",200);$("div#divEdit").dialog("option","minHeight",200);$("div#divEdit").dialog("open")}, linkEdit=function(a){a.preventDefault();edLink=$(a.currentTarget);action=edLink.hasClass("addLink")?"add":"edit";createLinkEditForm();title=$("input#title");href=$("input#href");result=$("input#result");tips=$("input#tips");allFields=$([]).add(title).add(href).add(result).add(tips);tipsError=$("legend#legend");if(action=="add"){$("div#divEdit").attr({title:"Ajouter un site"});href.val("http://");result.val("");tips.val("");title.val("")}else{$("div#divEdit").attr({title:"Edition d'un site"});href.val(edLink.attr("href")); result.val(edLink.attr("rel"));tips.val(edLink.attr("title"));title.val(edLink.text())}a={};$.extend(a,{Annuler:function(){$(this).dialog("close")}});action!="add"&&$.extend(a,{Supprimer:function(){$(this).dialog("close");edLink.parent().remove()}});$.extend(a,{Valider:function(){var b=true;allFields.removeClass("ui-state-error");if(b=(b=(b=b&&checkLength(title,"Titre",2,25))&&checkLength(href,"Lien",12,250))&&checkRegexp(href,/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i, "Ex. : &quot;http://www.site.com&quot;")){if(action=="add"){b=edLink.parent().prev();var c='<li class="sortLink"><a href="'+addslashes(input2html(href.val()))+'" rel="'+(result.val()?addslashes(input2html(result.val())):"")+'" title="'+(tips.val()?addslashes(input2html(tips.val())):"")+'" class="l" style="cursor:move;">'+input2html(title.val())+"</a></li>";$(c).insertAfter(b);$("ul.sortUlLink").sortable("refresh")}else{edLink.attr({href:addslashes(input2html(href.val())),rel:result.val()?addslashes(input2html(result.val())): "",title:tips.val()?addslashes(input2html(tips.val())):""});edLink.html(input2html(title.val()))}$(this).dialog("close");initLinkEvent();isEditedByUser()}}});initDial();$("div#divEdit").dialog("option","buttons",a);$("div#divEdit").dialog("option","height",360);$("div#divEdit").dialog("option","minHeight",360);$("div#divEdit").dialog("open")},serializeLinks=function(){var a=[],b={},c=[],d=-1;$("ul.sortUlLink").each(function(){$(this).find("a.l").each(function(){var e=$(this);c[c.length]={href:addslashes(e.attr("href")), result:addslashes(e.attr("rel")),tips:addslashes(e.attr("title")),title:addslashes(e.text())}});$(this).find("h3").each(function(){b.title=$(this).text();d++});b.data=c;a[d]=b;b={};c=[]});return a},saveSITES=function(){SITES=serializeLinks();var a="var SITES = [",b;for(b in SITES){a+="{title: '"+SITES[b].title+"', data : [";for(var c in SITES[b].data){var d=SITES[b].data[c];if(d.href&&d.title)a+="{href:'"+d.href+"', result:'"+d.result+"', tips:'"+d.tips+"', title:'"+d.title+"'},"}a=a.substring(0, a.length-1);a+="]},"}a=a.substring(0,a.length-1);a+="];";$.ajax({type:"POST",url:"index.php?action=update",cache:false,data:{SITES:a},success:function(e){quitEditByUser();quitEditMode();e=="1"?alert("Sauvegarde r&eacute;ussie"):alert("Vous devez vous connecter (avec Facebook) pour sauvegarder vos modifications")}});return false},isEditedByUser=function(){editedByUser=true;$("#infoTexte").hide();$("#Sauvegarder").show();$("#Annuler").show();window.onbeforeunload=function(){if(editedByUser)return"Quitter la page sans enregistrer ?"; return true}},quitEditByUser=function(){editedByUser=false;window.onbeforeunload=null;$("#infoTexte").show();$("#Sauvegarder").hide();$("#Annuler").hide()},prevent=function(a){a.preventDefault()},removeLinkEvent=function(){$("li h3").unbind("dblclick",catEdit);$("li a.l").unbind("click",prevent);$("li a.l").unbind("dblclick",linkEdit);$("li a.addLink").unbind("click",linkEdit)},initLinkEvent=function(){$("li h3").bind("dblclick",catEdit);$("li a.l").bind("click",prevent);$("li a.l").bind("dblclick", linkEdit);$("li a.addLink").bind("click",linkEdit)},quitEditMode=function(){if(!(editedByUser&&!confirm("Quitter la page sans enregistrer ?"))){quitEditByUser();$("div#divEditInfos").hide();removeLinkEvent();$("li.liAddLink").remove();$("ul.sortUlCat").sortable("destroy");$("ul.sortUlLink").sortable("destroy");$("li.sortLinkCat h3").css({cursor:""});$("a.l").css({cursor:""});$("ul.sortUlCat").removeClass("borderFocus");$("ul.sortUlLink").removeClass("borderFocus");initSites();if(document.location.hash== "#editmode")document.location.hash=""}},startEditMode=function(){quitEditByUser();$("div#divEditInfos").length==0?$("body").append('<div id="divEditInfos"><h3 style="display:inline;">Mode &eacute;dition : </h3><span id="infoTexte"><strong>Cliquez</strong> sur les liens ou les cat&eacute;gories pour les d&eacute;placer, <strong>double-cliquez</strong> pour les &eacute;diter</span> <button type="button" id="Sauvegarder" onclick="saveSITES();" title="Enregistrer les liens et le th&egrave;me de cette page (Connexion obligatoire avec Facebook)" style="display:none;">Sauvegarder</button> <button type="button" id="Annuler" onclick="quitEditByUser();quitEditMode();" title="Annuler les modifications" style="display:none;">Annuler</button></div>'): $("div#divEditInfos").show();$("li.liAddLink").length<1&&$("ul.sortUlLink").each(function(){var a=$(this).find("li.sortLink:last");$('<li class="liAddLink"><a href="javascript:void(0);" title="Ajouter un lien dans cette cat&eacute;gorie" class="addLink">[+]</a></li>').insertAfter(a)});$("ul.sortUlCat").addClass("borderFocus");$("ul.sortUlLink").addClass("borderFocus");$("ul.sortUlCat").sortable({handle:"li.sortLinkCat",forcePlaceholderSize:true,placeholder:"placeHolder",change:isEditedByUser});$("ul.sortUlLink").sortable({connectWith:"ul.sortUlLink", forcePlaceholderSize:true,placeholder:"placeHolder",items:"li:not(.sortLinkCat, .liAddLink)",change:isEditedByUser}).disableSelection();$("li.sortLinkCat h3").css({cursor:"move"});$("a.l").css({cursor:"move"});setUlCol(false);posItem();initLinkEvent();document.location.hash="editmode"};